import{c as v,_ as L}from"./index-BGkrm5xk.js";import{a as Q}from"./backupdb-D0ubyxCa.js";import{h as R,s as d,j,q as l,o as h,k as w,p as t,O as o,m as n,U as g,V as M,T as C,af as s}from"./vue-Cm_-Ome7.js";function A(r){return v({url:"/admin/PbootToBadoucms/getTables",method:"post",data:r})}function I(r){return v({url:"/admin/PbootToBadoucms/checkConfig",method:"post",data:r})}function O(r={}){return v({url:"/admin/PbootToBadoucms/migrate",method:"post",data:r})}function z(r={}){return v({url:"/admin/PbootToBadoucms/migrateFiles",method:"post",data:r})}const G={class:"default-main ba-table-box"},H={class:"table-main-content",style:{"margin-top":"20px"}},J={key:0,class:"config-form"},K={key:1},W={class:"config-info"},X={class:"table-list"},Y={class:"migration-actions"},Z=R({__name:"index",setup(r){const c=d({pbootPath:""}),f=d(!1),y=d(!1),P=d(""),m=d(!1),_=d([]),T=j(()=>_.value.some(e=>e.status!=="success")),V=e=>{switch(e){case"success":return"success";case"error":return"danger";case"pending":return"info";default:return""}},B=e=>{switch(e){case"success":return"已完成";case"error":return"失败";case"pending":return"待迁移";default:return"待迁移"}},N=async()=>{try{const e=await A(c.value);e.code===1?_.value=e.data.map(a=>({...a,status:"pending",migrating:!1})):s.error(e.msg||"获取表列表失败")}catch(e){s.error(e.message||"获取表列表失败")}},F=async()=>{if(!c.value.pbootPath){s.warning("请输入PbootCMS目录路径");return}try{y.value=!0;const e=await I(c.value);e.code===1?(f.value=!0,P.value=e.data.type,s.success(e.msg),await N()):s.error(e.msg)}catch(e){s.error(e.message||"配置验证失败")}finally{y.value=!1}},U=async()=>{if(!f.value){s.warning("请先验证PbootCMS配置");return}try{m.value=!0;const e=await Q();if(e.code!==1){s.error(e.msg||"备份失败");return}for(const i of _.value.filter(b=>b.status==="pending"))try{(await O({...c.value,tableName:i.name})).code===1&&(i.status="success")}catch{i.status="error"}m.value=!1;const a=await z(c.value);a.code!==1&&s.error(a.msg)}catch(e){m.value=!1,s.error(e.message||"迁移失败")}};return(e,a)=>{const i=l("el-alert"),b=l("el-input"),x=l("el-form-item"),k=l("el-button"),q=l("el-form"),p=l("el-table-column"),S=l("el-tag"),D=l("el-table"),E=l("el-card");return h(),w("div",G,[t(E,{class:"table-main",shadow:"never"},{default:o(()=>[a[3]||(a[3]=n("div",{class:"table-header"},[n("h3",{class:"table-header-title"},"PbootCMS数据迁移")],-1)),n("div",H,[t(i,{type:"success"},{default:o(()=>a[1]||(a[1]=[n("p",null,"1、请先将pbootcms程序复制到BadouCms的跟目录下",-1),n("p",null,"2、在下方的PbootCMS文件夹中填入刚刚复制过来的pbootcms程序名称",-1),n("p",null,"3、迁移过程中请勿刷新页面或关闭浏览器。",-1)])),_:1}),f.value?M("",!0):(h(),w("div",J,[t(q,{model:c.value,"label-width":"150px"},{default:o(()=>[t(x,{label:"PbootCMS文件夹"},{default:o(()=>[t(b,{modelValue:c.value.pbootPath,"onUpdate:modelValue":a[0]||(a[0]=u=>c.value.pbootPath=u),placeholder:"请输入PbootCMS的文件夹名称"},null,8,["modelValue"])]),_:1}),t(x,null,{default:o(()=>[t(k,{type:"primary",onClick:F,loading:y.value},{default:o(()=>a[2]||(a[2]=[g("验证配置")])),_:1},8,["loading"])]),_:1})]),_:1},8,["model"])])),f.value?(h(),w("div",K,[n("div",W,[t(i,{title:"已成功连接到 "+(P.value==="mysql"?"MySQL":"SQLite")+" 数据库",type:"success","show-icon":""},null,8,["title"])]),n("div",X,[t(D,{data:_.value,style:{width:"100%"}},{default:o(()=>[t(p,{prop:"name",label:"表名"}),t(p,{prop:"target",label:"目标表名"}),t(p,{prop:"type",label:"类型"},{default:o(u=>[t(S,{type:u.row.type==="system"?"":"success"},{default:o(()=>[g(C(u.row.type==="system"?"系统表":"自定义表"),1)]),_:2},1032,["type"])]),_:1}),t(p,{prop:"count",label:"记录数"}),t(p,{prop:"status",label:"状态"},{default:o(u=>[t(S,{type:V(u.row.status)},{default:o(()=>[g(C(B(u.row.status)),1)]),_:2},1032,["type"])]),_:1})]),_:1},8,["data"])]),n("div",Y,[t(k,{type:"primary",onClick:U,loading:m.value,disabled:!T.value},{default:o(()=>[g(C(T.value?m.value?"迁移中...":"开始迁移全部":"迁移完成"),1)]),_:1},8,["loading","disabled"])])])):M("",!0)])]),_:1})])}}}),ae=L(Z,[["__scopeId","data-v-956adc37"]]);export{ae as default};
